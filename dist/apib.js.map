{"version":3,"file":"apib.js","sources":["../lib/apib.js"],"sourcesContent":["'use strict'\r\n\r\nimport axios from 'axios'\r\n\r\nimport { version } from '../package.json'\r\n\r\nclass API {\r\n  axios = axios\r\n\r\n  version = version\r\n\r\n  constructor(options = {}) {\r\n    this.options = options\r\n  }\r\n\r\n  log(...args) {\r\n    if (this.options.debug) {\r\n      console.log(...args) // eslint-disable-line no-console\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 将对象转为 URL QueryString\r\n   *\r\n   * @param {object} data\r\n   */\r\n  _param(data) {\r\n    let ret = []\r\n    Object.keys(data).forEach(v => {\r\n      ret.push(`${encodeURIComponent(v)}=${encodeURIComponent(data[v])}`)\r\n    })\r\n    return ret.join('&')\r\n  }\r\n\r\n  /**\r\n   * 类型判断\r\n   *\r\n   * @param {*} unknown\r\n   * @return {string}\r\n   */\r\n  _type(unknown) {\r\n    const type = Object.prototype.toString.call(unknown)\r\n    return type.replace('[object ', '').replace(']', '').toLowerCase()\r\n  }\r\n\r\n  /**\r\n   * 将参数列表转为对象形式\r\n   *\r\n   * @param {array} args 参数原始对象，即 arguments\r\n   * @param {array} names 参数名称对应的数组，可以给默认值，默认值需要能被 JSON.parse 解析。\r\n   *\r\n   * 注意：\r\n   *  - 参数的值支持覆盖\r\n   *  - 在遇到对象之后直接退出\r\n   *\r\n   * 示例：\r\n   *   > _args ([1, 2, {xor: true}], ['offset', 'count'])\r\n   *   < {offset: 1, count: 2, xor: true}\r\n   */\r\n  _args(args, names = []) {\r\n    const options = {}\r\n    names.forEach((item, index) => {\r\n      if (item.indexOf('=') > -1) {\r\n        const temp = item.split('=')\r\n        const name = temp[0]\r\n        names[index] = name\r\n        try {\r\n          options[name] = JSON.parse(temp.slice(1).join('='))\r\n        } catch (e) {\r\n          //\r\n        }\r\n        // const [name, ...value] = item.split('=')\r\n        // names[index] = name\r\n        // try {\r\n        //   options[name] = JSON.parse(value.join('='))\r\n        // } catch (e) {\r\n        //   //\r\n        // }\r\n      }\r\n    })\r\n    for (let i = 0; i < args.length; i++) {\r\n      if (this._type(args[i]) === 'object') {\r\n        Object.assign(options, args[i])\r\n        break\r\n      } else if (\r\n        this._type(args[i]) !== 'undefined'\r\n        && this._type(names[i]) !== 'undefined'\r\n      ) {\r\n        options[names[i]] = args[i]\r\n      }\r\n    }\r\n    return options\r\n  }\r\n\r\n  /**\r\n   * 拼接链接地址\r\n   *\r\n   * @param  {array<string>} args\r\n   */\r\n  _join(...args) {\r\n    let result = args[0] || ''\r\n    for (let i = 1; i < args.length; i++) {\r\n      if (args[i]) {\r\n        result = result.replace(/\\/+$/, '') + '/' + args[i].replace(/^\\/+/, '')\r\n      }\r\n    }\r\n    return result\r\n  }\r\n\r\n  /**\r\n   * 通用请求封装\r\n   */\r\n  request(...args) {\r\n    const options = this._args(args, ['url'])\r\n\r\n    if (!options.url) {\r\n      throw new Error('url is required')\r\n    }\r\n\r\n    if (!options.method && this.options.method) {\r\n      options.method = this.options.method\r\n    }\r\n\r\n    const successCode = typeof this.options.code === 'number' ? this.options.code : 1\r\n\r\n    return new Promise((resolve, reject) => {\r\n      this.axios.create({\r\n        withCredentials: true,\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        baseURL: this.options.baseUrl,\r\n        timeout: this.options.timeout\r\n      })(options).then(response => {\r\n        let res = response.data || {}\r\n\r\n        const code = +res.code\r\n\r\n        if (code === successCode) {\r\n          resolve(res)\r\n        } else {\r\n          reject(res)\r\n        }\r\n        this.log('then', {response, args, options, res, raw: JSON.stringify(res)})\r\n      }).catch(error => {\r\n        reject(error)\r\n        this.log('catch', {error, args, options, response: error.response})\r\n      })\r\n    })\r\n  }\r\n\r\n}\r\n\r\nexport default API\r\n"],"names":["API","options","axios","version","log","debug","console","_param","data","ret","Object","keys","forEach","v","push","encodeURIComponent","join","_type","unknown","type","prototype","toString","call","replace","toLowerCase","_args","args","names","item","index","indexOf","temp","split","name","JSON","parse","slice","e","i","length","assign","_join","result","request","url","Error","method","successCode","code","Promise","resolve","reject","create","withCredentials","headers","baseURL","baseUrl","timeout","then","response","res","raw","stringify","error"],"mappings":"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"}